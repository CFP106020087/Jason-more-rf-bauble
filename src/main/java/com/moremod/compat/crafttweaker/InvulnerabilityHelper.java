package com.moremod.compat.crafttweaker;

import net.minecraft.entity.Entity;
import net.minecraft.entity.EntityLivingBase;
import net.minecraft.util.CombatRules;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

/**
 * 无敌帧(i-frames)管理器
 * 
 * 功能:
 * - 减少目标的无敌时间,允许更快的连击
 * - 追踪每个实体的无敌帧减少效果
 * - 提供灵活的配置选项
 * 
 * 原理:
 * Minecraft中实体受到伤害后会有hurtResistantTime(无敌时间)
 * 这个类通过减少这个时间来允许更快的连击攻击
 */
public class InvulnerabilityHelper {
    
    // 追踪实体的无敌帧减少数据
    private static final Map<UUID, InvulnerabilityData> INVULN_DATA = new HashMap<>();
    
    // 调试模式
    private static boolean DEBUG = false;
    
    /**
     * 无敌帧数据
     */
    private static class InvulnerabilityData {
        float reductionPercent = 0.0f;  // 减少百分比
        int flatReduction = 0;           // 固定减少tick数
        long lastUpdateTime = 0;         // 最后更新时间
        int applyCount = 0;              // 应用次数(用于统计)
        
        public InvulnerabilityData(float reductionPercent, int flatReduction) {
            this.reductionPercent = reductionPercent;
            this.flatReduction = flatReduction;
            this.lastUpdateTime = System.currentTimeMillis();
        }
        
        public void update(float reductionPercent, int flatReduction) {
            // 取最大值(不叠加,避免过强)
            this.reductionPercent = Math.max(this.reductionPercent, reductionPercent);
            this.flatReduction = Math.max(this.flatReduction, flatReduction);
            this.lastUpdateTime = System.currentTimeMillis();
        }
        
        public boolean isExpired() {
            // 5秒后过期
            return System.currentTimeMillis() - lastUpdateTime > 5000;
        }
    }
    
    // ==========================================
    // 核心方法
    // ==========================================
    
    /**
     * 应用无敌帧减少效果到目标
     * 
     * @param target 目标实体
     * @param reductionPercent 减少百分比 (0.0-1.0, 0.5 = 减少50%无敌时间)
     * @param flatReduction 固定减少的tick数
     * @return 是否成功应用
     */
    public static boolean applyReduction(EntityLivingBase target, 
                                        float reductionPercent, 
                                        int flatReduction) {
        if (target == null || target.isDead) {
            return false;
        }
        
        UUID uuid = target.getUniqueID();
        InvulnerabilityData data = INVULN_DATA.get(uuid);
        
        if (data == null) {
            data = new InvulnerabilityData(reductionPercent, flatReduction);
            INVULN_DATA.put(uuid, data);
        } else {
            data.update(reductionPercent, flatReduction);
        }
        
        // 立即应用到当前的无敌时间
        if (target.hurtResistantTime > 0) {
            int originalTime = target.hurtResistantTime;
            reduceInvulnerabilityTime(target, reductionPercent, flatReduction);
            data.applyCount++;
            
            if (DEBUG) {
                System.out.println(String.format(
                    "[InvulnHelper] 减少无敌帧: %s (%d -> %d tick, -%.0f%%, -%d tick)",
                    target.getName(), originalTime, target.hurtResistantTime,
                    reductionPercent * 100, flatReduction
                ));
            }
        }
        
        return true;
    }
    
    /**
     * 直接减少目标的当前无敌时间
     */
    public static void reduceInvulnerabilityTime(EntityLivingBase target,
                                                 float reductionPercent,
                                                 int flatReduction) {
        if (target == null || target.hurtResistantTime <= 0) {
            return;
        }
        
        int originalTime = target.hurtResistantTime;
        
        // 先应用百分比减少
        if (reductionPercent > 0) {
            target.hurtResistantTime = (int)(target.hurtResistantTime * (1.0f - reductionPercent));
        }
        
        // 再应用固定减少
        if (flatReduction > 0) {
            target.hurtResistantTime -= flatReduction;
        }
        
        // 确保不会小于0
        target.hurtResistantTime = Math.max(0, target.hurtResistantTime);
        
        if (DEBUG && originalTime != target.hurtResistantTime) {
            System.out.println(String.format(
                "[InvulnHelper] 无敌帧: %d -> %d (减少了%d tick)",
                originalTime, target.hurtResistantTime, 
                originalTime - target.hurtResistantTime
            ));
        }
    }
    
    /**
     * 获取目标的无敌帧减少数据
     */
    public static InvulnerabilityData getReductionData(EntityLivingBase target) {
        if (target == null) return null;
        
        UUID uuid = target.getUniqueID();
        InvulnerabilityData data = INVULN_DATA.get(uuid);
        
        // 清理过期数据
        if (data != null && data.isExpired()) {
            INVULN_DATA.remove(uuid);
            return null;
        }
        
        return data;
    }
    
    /**
     * 检查目标是否有无敌帧减少效果
     */
    public static boolean hasReduction(EntityLivingBase target) {
        return getReductionData(target) != null;
    }
    
    /**
     * 清除目标的无敌帧减少效果
     */
    public static void clearReduction(EntityLivingBase target) {
        if (target != null) {
            INVULN_DATA.remove(target.getUniqueID());
        }
    }
    
    /**
     * 完全移除目标的无敌时间(调试/测试用)
     */
    public static void removeInvulnerability(EntityLivingBase target) {
        if (target != null) {
            target.hurtResistantTime = 0;
            
            if (DEBUG) {
                System.out.println("[InvulnHelper] 完全移除无敌帧: " + target.getName());
            }
        }
    }
    
    /**
     * 设置目标的最大无敌时间
     */
    public static void setMaxInvulnerabilityTime(EntityLivingBase target, int maxTime) {
        if (target != null) {
            target.maxHurtResistantTime = maxTime;
            
            if (DEBUG) {
                System.out.println(String.format(
                    "[InvulnHelper] 设置最大无敌时间: %s = %d tick",
                    target.getName(), maxTime
                ));
            }
        }
    }
    
    // ==========================================
    // 查询方法
    // ==========================================
    
    /**
     * 获取目标当前的无敌时间
     */
    public static int getInvulnerabilityTime(EntityLivingBase target) {
        return target != null ? target.hurtResistantTime : 0;
    }
    
    /**
     * 获取目标的最大无敌时间
     */
    public static int getMaxInvulnerabilityTime(EntityLivingBase target) {
        return target != null ? target.maxHurtResistantTime : 20;
    }
    
    /**
     * 检查目标是否处于无敌状态
     */
    public static boolean isInvulnerable(EntityLivingBase target) {
        return target != null && target.hurtResistantTime > 0;
    }
    
    /**
     * 获取目标的无敌帧减少百分比
     */
    public static float getReductionPercent(EntityLivingBase target) {
        InvulnerabilityData data = getReductionData(target);
        return data != null ? data.reductionPercent : 0.0f;
    }
    
    /**
     * 获取目标的固定无敌帧减少
     */
    public static int getFlatReduction(EntityLivingBase target) {
        InvulnerabilityData data = getReductionData(target);
        return data != null ? data.flatReduction : 0;
    }
    
    /**
     * 获取总共应用的次数(统计用)
     */
    public static int getApplyCount(EntityLivingBase target) {
        InvulnerabilityData data = getReductionData(target);
        return data != null ? data.applyCount : 0;
    }
    
    // ==========================================
    // 管理方法
    // ==========================================
    
    /**
     * 清理所有过期数据
     */
    public static void cleanupExpiredData() {
        INVULN_DATA.entrySet().removeIf(entry -> entry.getValue().isExpired());
    }
    
    /**
     * 清空所有数据
     */
    public static void clearAll() {
        INVULN_DATA.clear();
        if (DEBUG) {
            System.out.println("[InvulnHelper] 已清空所有无敌帧数据");
        }
    }
    
    /**
     * 启用/禁用调试模式
     */
    public static void setDebugMode(boolean enable) {
        DEBUG = enable;
        System.out.println("[InvulnHelper] 调试模式: " + (enable ? "开启" : "关闭"));
    }
    
    /**
     * 获取统计信息
     */
    public static String getStatistics() {
        int totalEntities = INVULN_DATA.size();
        int totalApplies = INVULN_DATA.values().stream()
                .mapToInt(d -> d.applyCount)
                .sum();
        
        return String.format(
            "无敌帧管理器统计: %d个实体, 总计应用%d次",
            totalEntities, totalApplies
        );
    }
    
    // ==========================================
    // 预设配置
    // ==========================================
    
    /**
     * 轻度减少 (25%减少)
     */
    public static boolean applyLightReduction(EntityLivingBase target) {
        return applyReduction(target, 0.25f, 2);
    }
    
    /**
     * 中度减少 (50%减少)
     */
    public static boolean applyMediumReduction(EntityLivingBase target) {
        return applyReduction(target, 0.50f, 5);
    }
    
    /**
     * 重度减少 (75%减少)
     */
    public static boolean applyHeavyReduction(EntityLivingBase target) {
        return applyReduction(target, 0.75f, 10);
    }
    
    /**
     * 极限减少 (90%减少)
     */
    public static boolean applyExtremeReduction(EntityLivingBase target) {
        return applyReduction(target, 0.90f, 15);
    }
}